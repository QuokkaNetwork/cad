========================================
VOICE BRIDGE AUTO-CONFIGURATION GUIDE
========================================

This guide explains how to set up the voice bridge with automatic Mumble detection from your FiveM server.


WHAT'S BEEN CONFIGURED:
-----------------------

✅ Bridge authentication token generated and configured in both:
   - CAD .env: FIVEM_BRIDGE_SHARED_TOKEN
   - FiveM Lua script: BRIDGE_TOKEN

✅ Auto-detection script created:
   - fivem-radio-channel-sync-enhanced.lua

✅ CAD endpoints created:
   - POST /api/fivem/mumble-config/sync (auto-configures Mumble settings)
   - POST /api/fivem/radio-channels/sync (syncs channel names)


STEP 1: ADD SCRIPT TO FIVEM SERVER
-----------------------------------

Option A - Add to existing cad-bridge resource:
1. Copy fivem-radio-channel-sync-enhanced.lua to your cad-bridge resource
2. Add to cad-bridge/fxmanifest.lua:
   server_scripts {
       'fivem-radio-channel-sync-enhanced.lua'
   }

Option B - Create standalone resource:
1. Create: resources/[standalone]/cad-bridge-sync/
2. Place fivem-radio-channel-sync-enhanced.lua inside
3. Create fxmanifest.lua:
   fx_version 'cerulean'
   game 'gta5'
   server_script 'fivem-radio-channel-sync-enhanced.lua'
4. Add to server.cfg: ensure cad-bridge-sync


STEP 2: CONFIGURE RADIO CHANNELS
---------------------------------

Edit fivem-radio-channel-sync-enhanced.lua and update the RADIO_CHANNELS table
to match your ACTUAL in-game radio channels:

Example for pma-voice setup:
```lua
local RADIO_CHANNELS = {
    {id = 1, name = "Police Primary", description = "Main police channel"},
    {id = 2, name = "Police Backup", description = "Backup channel"},
    {id = 3, name = "Police Traffic", description = "Traffic coordination"},
    {id = 4, name = "EMS Primary", description = "EMS/Ambulance"},
    {id = 5, name = "Fire Primary", description = "Fire department"},
}
```

IMPORTANT: Channel IDs must match what players use with /radio command!


STEP 3: START YOUR FIVEM SERVER
--------------------------------

When your FiveM server starts, the script will:

1. ✅ Auto-detect your voice system (pma-voice, mumble-voip, etc.)
2. ✅ Find the Mumble server port automatically
3. ✅ Send Mumble configuration to CAD
4. ✅ Sync radio channel names to CAD

Check your FiveM console for:
   [CAD Bridge Sync] Starting...
   Voice System: pma-voice
   Mumble Server: 127.0.0.1:64738
   [CAD Mumble Sync] Successfully synced Mumble config to CAD
   [CAD Radio Sync] Success! Synced 5 channels (5 created, 0 updated)


STEP 4: RESTART CAD SERVER
---------------------------

After FiveM has synced the configuration:

1. Restart your CAD server to load the new Mumble settings
2. CAD will now use the auto-detected Mumble port
3. Check CAD console for:
   [VoiceBridge] Using auto-detected Mumble config: 127.0.0.1:XXXX (pma-voice)


STEP 5: VERIFY IN CAD
---------------------

1. Login to CAD as a dispatcher
2. Go to Voice tab
3. Should show "Voice Bridge Connected" (green)
4. Channel names should match your FiveM radio channels


TROUBLESHOOTING
---------------

Voice Bridge shows "Disconnected":
→ Check FiveM console for Mumble detection results
→ Run "checkmumble" in FiveM console to see detected config
→ Restart CAD server after FiveM sync
→ Check CAD console for connection errors

Channels not syncing:
→ Run "synccad" in FiveM console to manually trigger sync
→ Check BRIDGE_TOKEN matches in both .env and Lua script
→ Verify CAD URL is correct in Lua script

pma-voice WebRTC mode detected:
→ Voice bridge only works with Mumble mode
→ Either switch pma-voice to Mumble, or disable voice bridge
→ Check pma-voice config: voiceMode = 0 (Mumble) or 1 (WebRTC)


CONSOLE COMMANDS (FIVEM)
-------------------------

synccad          - Manually sync Mumble config and radio channels
checkmumble      - Show detected Mumble configuration

Both commands are console-only for security.


HOW AUTO-DETECTION WORKS
-------------------------

The script attempts to detect your voice system in this order:

1. pma-voice
   - Checks if pma-voice export exists
   - Detects Mumble mode vs WebRTC mode
   - Reads Mumble port from pma-voice config

2. mumble-voip (legacy)
   - Checks for mumble-voip export
   - Uses standard port 64738

3. tokovoip (very legacy)
   - Checks for tokovoip export
   - Uses standard port 64738

4. Fallback
   - If nothing detected, tries port 64738
   - May not work if your server uses a different port


MANUAL CONFIGURATION (FALLBACK)
--------------------------------

If auto-detection fails, you can manually configure in CAD .env:

MUMBLE_HOST=127.0.0.1
MUMBLE_PORT=64747  # Or whatever port your Mumble server uses

Then restart CAD server.


NOTES
-----

- Auto-sync runs every 30 minutes to catch config changes
- Settings are stored in CAD database after first sync
- Database settings take precedence over .env
- If you change voice system, run "synccad" to update CAD
