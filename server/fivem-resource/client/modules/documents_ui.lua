local util = CadBridge and CadBridge.util or {}
local ui = CadBridge and CadBridge.ui or {}
local state = CadBridge and CadBridge.state or {}

local function trim(value)
  if type(util.trim) == 'function' then
    return util.trim(value)
  end
  if value == nil then return '' end
  return (tostring(value):gsub('^%s+', ''):gsub('%s+$', ''))
end

local function triggerNotify(payload)
  if type(util.triggerCadOxNotify) == 'function' then
    return util.triggerCadOxNotify(payload)
  end
  return false
end

local function notifyEmergencyUiIssue(message)
  local text = tostring(message or 'Unable to open the 000 UI right now.')
  if triggerNotify({
    title = 'CAD Dispatch',
    description = text,
    type = 'warning',
  }) then
    return
  end

  if GetResourceState('chat') == 'started' then
    TriggerEvent('chat:addMessage', {
      color = { 255, 170, 0 },
      args = { 'CAD', text },
    })
  end
end

local function setEmergencyUiVisible(isVisible, payload)
  local visible = isVisible == true
  state.emergencyUiOpen = visible

  if visible then
    state.emergencyUiAwaitingOpenAck = true
    state.emergencyUiOpenedAtMs = tonumber(GetGameTimer() or 0) or 0
    SetNuiFocus(true, true)
    Wait(10)
    SetNuiFocus(true, true)

    SendNUIMessage({
      action = 'cadBridge000:open',
      payload = payload or {},
    })
    Wait(10)
    SendNUIMessage({
      action = 'cadBridge000:open',
      payload = payload or {},
    })
  else
    state.emergencyUiAwaitingOpenAck = false
    state.emergencyUiOpenedAtMs = 0
    if type(ui.refreshCadBridgeNuiFocus) == 'function' then
      ui.refreshCadBridgeNuiFocus()
    else
      SetNuiFocus(false, false)
    end
    SendNUIMessage({
      action = 'cadBridge000:close',
      payload = {},
    })
  end
end

local function sanitizeEmergencyDepartments(departments)
  local out = {}
  if type(departments) ~= 'table' then return out end

  for _, dept in ipairs(departments) do
    local id = tonumber(dept.id)
    if id and id > 0 then
      out[#out + 1] = {
        id = math.floor(id),
        name = trim(dept.name or ('Department #' .. tostring(id))),
        short_name = trim(dept.short_name or ''),
        color = trim(dept.color or ''),
      }
    end
  end

  return out
end

local function closeEmergencyPopup()
  if not state.emergencyUiOpen then return end
  setEmergencyUiVisible(false, {})
end
ui.closeEmergencyPopup = closeEmergencyPopup

local function openEmergencyPopup(departments)
  if not state.emergencyUiReady then
    local attempts = 0
    while not state.emergencyUiReady and attempts < 20 do
      attempts = attempts + 1
      Wait(50)
    end
  end

  if not state.emergencyUiReady then
    notifyEmergencyUiIssue('000 UI may not be fully loaded. If nothing appears, restart cad_bridge.')
  end

  if state.driverLicenseUiOpen and type(ui.closeDriverLicensePopup) == 'function' then
    ui.closeDriverLicensePopup()
  end
  if state.vehicleRegistrationUiOpen and type(ui.closeVehicleRegistrationPopup) == 'function' then
    ui.closeVehicleRegistrationPopup()
  end

  local payload = {
    departments = sanitizeEmergencyDepartments(departments),
    max_title_length = 80,
    max_details_length = 600,
  }

  setEmergencyUiVisible(true, payload)

  CreateThread(function()
    Wait(2000)
    if state.emergencyUiOpen and state.emergencyUiAwaitingOpenAck then
      SendNUIMessage({
        action = 'cadBridge000:open',
        payload = payload,
      })
    end
  end)
end
ui.openEmergencyPopup = openEmergencyPopup

local function closeShownIdCard()
  if not state.idCardUiOpen then return end
  state.idCardUiOpen = false
  SendNUIMessage({
    action = 'cadBridgeIdCard:hide',
    payload = {},
  })
end

local function openShownIdCard(payload)
  state.idCardUiOpen = true
  SendNUIMessage({
    action = 'cadBridgeIdCard:show',
    payload = payload or {},
  })
end

RegisterNUICallback('cadBridge000Ready', function(_data, cb)
  state.emergencyUiReady = true
  if cb then cb({ ok = true }) end
end)

RegisterNUICallback('cadBridge000Opened', function(_data, cb)
  state.emergencyUiAwaitingOpenAck = false
  state.emergencyUiOpenedAtMs = 0
  if cb then cb({ ok = true }) end
end)

RegisterNUICallback('cadBridge000Submit', function(data, cb)
  local title = trim(data and data.title or '')
  local details = trim(data and data.details or '')
  local requestedDepartmentIds = {}
  if type(util.normalizeDepartmentIdList) == 'function' then
    requestedDepartmentIds = util.normalizeDepartmentIdList(data and data.requested_department_ids or {})
  end

  if title == '' then
    if cb then cb({ ok = false, error = 'title_required' }) end
    return
  end

  if #title > 80 then title = title:sub(1, 80) end
  if #details > 600 then details = details:sub(1, 600) end

  closeEmergencyPopup()
  TriggerServerEvent('cad_bridge:submit000', {
    title = title,
    details = details,
    requested_department_ids = requestedDepartmentIds,
  })

  if cb then cb({ ok = true }) end
end)

RegisterNUICallback('cadBridge000Cancel', function(_data, cb)
  closeEmergencyPopup()
  if cb then cb({ ok = true }) end
end)

RegisterNUICallback('cadBridgeIdCardClose', function(_data, cb)
  closeShownIdCard()
  if cb then cb({ ok = true }) end
end)

RegisterNetEvent('cad_bridge:prompt000', function(departments)
  openEmergencyPopup(departments)
end)

RegisterNetEvent('cad_bridge:showIdCard', function(payload)
  openShownIdCard(payload or {})
end)

RegisterNetEvent('cad_bridge:hideIdCard', function()
  closeShownIdCard()
end)

local SHOW_ID_COMMAND = trim(Config.ShowIdCommand or 'showid')
if SHOW_ID_COMMAND == '' then SHOW_ID_COMMAND = 'showid' end
local SHOW_ID_KEY = trim(Config.ShowIdKey or 'PAGEDOWN')
if SHOW_ID_KEY == '' then SHOW_ID_KEY = 'PAGEDOWN' end
local SHOW_ID_MAX_DISTANCE = tonumber(Config.ShowIdTargetDistance or 4.0) or 4.0

local function findFacingPlayerServerId(maxDistance)
  local ped = PlayerPedId()
  if not ped or ped == 0 then return 0 end

  local origin = GetEntityCoords(ped)
  local forward = GetEntityForwardVector(ped)
  local localPlayer = PlayerId()
  local distanceLimit = tonumber(maxDistance) or 4.0
  if distanceLimit < 1.0 then distanceLimit = 1.0 end

  local bestServerId = 0
  local bestScore = 0.0
  for _, player in ipairs(GetActivePlayers()) do
    if player ~= localPlayer then
      local targetPed = GetPlayerPed(player)
      if targetPed and targetPed ~= 0 then
        local targetCoords = GetEntityCoords(targetPed)
        local dx = targetCoords.x - origin.x
        local dy = targetCoords.y - origin.y
        local dz = targetCoords.z - origin.z
        local distance = math.sqrt((dx * dx) + (dy * dy) + (dz * dz))
        if distance > 0.001 and distance <= distanceLimit then
          local invDistance = 1.0 / distance
          local dot = (forward.x * dx * invDistance) + (forward.y * dy * invDistance) + (forward.z * dz * invDistance)
          if dot >= 0.35 then
            local score = dot + (1.0 - (distance / distanceLimit))
            if score > bestScore then
              bestScore = score
              bestServerId = GetPlayerServerId(player)
            end
          end
        end
      end
    end
  end

  return tonumber(bestServerId) or 0
end

local function requestShowIdCard()
  local targetSource = findFacingPlayerServerId(SHOW_ID_MAX_DISTANCE)
  TriggerServerEvent('cad_bridge:requestShowId', targetSource)
end

RegisterCommand(SHOW_ID_COMMAND, function()
  requestShowIdCard()
end, false)

RegisterCommand('cadbridgecloseid', function()
  closeShownIdCard()
end, false)

RegisterCommand('cadbridgeidtoggle', function()
  if state.idCardUiOpen then
    closeShownIdCard()
    return
  end
  requestShowIdCard()
end, false)

RegisterKeyMapping('cadbridgeidtoggle', 'Show or hide your ID card', 'keyboard', SHOW_ID_KEY)

RegisterCommand('test000ui', function()
  openEmergencyPopup({
    { id = 1, name = 'Police Department', short_name = 'LSPD', color = '#3b82f6' },
    { id = 2, name = 'Fire Department', short_name = 'LSFD', color = '#ef4444' },
    { id = 3, name = 'Emergency Medical Services', short_name = 'EMS', color = '#10b981' },
  })
end, false)

AddEventHandler('onResourceStop', function(resourceName)
  if resourceName ~= GetCurrentResourceName() then return end
  if state.idCardUiOpen then
    closeShownIdCard()
  end
  if type(ui.closeAllModals) == 'function' then
    ui.closeAllModals()
  elseif state.emergencyUiOpen then
    closeEmergencyPopup()
  end
  SetNuiFocus(false, false)
end)

CreateThread(function()
  while true do
    local hasModalOpen = false
    if type(ui.hasAnyCadBridgeModalOpen) == 'function' then
      hasModalOpen = ui.hasAnyCadBridgeModalOpen()
    end

    if hasModalOpen then
      Wait(0)

      if IsControlJustPressed(0, 200) or IsControlJustPressed(0, 202) or IsControlJustPressed(0, 177) then
        if type(ui.closeAllModals) == 'function' then
          ui.closeAllModals()
        else
          closeEmergencyPopup()
          if type(ui.closeDriverLicensePopup) == 'function' then ui.closeDriverLicensePopup() end
          if type(ui.closeVehicleRegistrationPopup) == 'function' then ui.closeVehicleRegistrationPopup() end
        end
      end

      if state.emergencyUiAwaitingOpenAck and (tonumber(state.emergencyUiOpenedAtMs or 0) > 0) then
        local nowMs = tonumber(GetGameTimer() or 0) or 0
        if (nowMs - tonumber(state.emergencyUiOpenedAtMs or 0)) > 2500 then
          closeEmergencyPopup()
          notifyEmergencyUiIssue('000 UI failed to initialize. Focus was released.')
        end
      end
    else
      Wait(250)
    end
  end
end)
